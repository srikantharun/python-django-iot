{% extends "base.html" %}

{% block title %}IoT Device Dashboard{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="row">
        <div class="col-md-4">
            <h2>Devices</h2>
            <div class="device-list">
                {% for device in devices %}
                <div class="device-card {% if device.is_active %}active{% else %}inactive{% endif %}" 
                     data-device-id="{{ device.device_id }}">
                    <h3>{{ device.name }}</h3>
                    <p>ID: {{ device.device_id }}</p>
                    <p>Type: {{ device.type }}</p>
                    <p>Status: {% if device.is_active %}Active{% else %}Inactive{% endif %}</p>
                    <p>Last seen: {{ device.last_seen|default:"Never" }}</p>
                </div>
                {% empty %}
                <p>No devices registered yet.</p>
                {% endfor %}
            </div>
        </div>
        <div class="col-md-8">
            <div id="device-details">
                <h2>Device Details</h2>
                <div id="charts-container">
                    <div id="temperature-chart" class="chart"></div>
                    <div id="humidity-chart" class="chart"></div>
                </div>
                <div id="real-time-data">
                    <h3>Real-time Data</h3>
                    <div id="current-readings"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- WebSocket connection for real-time updates -->
<script>
    const deviceSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/devices/'
    );

    deviceSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        updateDeviceData(data);
    };

    function updateDeviceData(data) {
        // Update UI with real-time data
        if (data.device_id === currentDeviceId) {
            document.getElementById('current-readings').innerHTML = `
                <p>Temperature: ${data.temperature}Â°C</p>
                <p>Humidity: ${data.humidity}%</p>
                <p>Timestamp: ${new Date(data.timestamp).toLocaleString()}</p>
            `;
            
            // Update charts
            addDataPoint(temperatureChart, data.timestamp, data.temperature);
            addDataPoint(humidityChart, data.timestamp, data.humidity);
        }
    }
</script>
{% endblock %}
