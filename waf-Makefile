ENVIRONMENT ?= poc
WAF_ENDPOINT ?= https://waf-test.example.com
WAF_LOG_GROUP ?= aws-waf-logs-$(ENVIRONMENT)
AWS_REGION ?= eu-west-1
AWS_ACCOUNT_ID ?= 052407073588

.PHONY: test test-install test-clean test-validate test-report test-coverage help

test-install:
	pip install pytest pyyaml pydantic pytest-html pytest-cov

test-clean:
	rm -rf reports/* .pytest_cache tests/.pytest_cache tests/waf/.pytest_cache .coverage htmlcov
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true

test-validate:
	@test -n "$(MODULE)" || (echo "ERROR: MODULE required"; exit 1)
	python -c "import yaml; from pathlib import Path; print('Validating $(MODULE)...')"

test:
	@test -n "$(MODULE)" || (echo "ERROR: MODULE required"; exit 1)
	pytest tests/waf/ -v -s --tb=short --waf-endpoint=$(WAF_ENDPOINT) --waf-log-group=$(WAF_LOG_GROUP) --aws-region=$(AWS_REGION) --account-id=$(AWS_ACCOUNT_ID) --waf-module=$(MODULE)

test-report:
	@test -n "$(MODULE)" || (echo "ERROR: MODULE required"; exit 1)
	@mkdir -p reports
	pytest tests/waf/ -v --waf-endpoint=$(WAF_ENDPOINT) --waf-log-group=$(WAF_LOG_GROUP) --aws-region=$(AWS_REGION) --account-id=$(AWS_ACCOUNT_ID) --waf-module=$(MODULE) --html=reports/$(MODULE).html --junitxml=reports/$(MODULE)_junit.xml

test-coverage:
	@test -n "$(MODULE)" || (echo "ERROR: MODULE required"; exit 1)
	@mkdir -p reports
	pytest tests/waf/ -v --waf-endpoint=$(WAF_ENDPOINT) --waf-log-group=$(WAF_LOG_GROUP) --aws-region=$(AWS_REGION) --account-id=$(AWS_ACCOUNT_ID) --waf-module=$(MODULE) --cov=tests/waf --cov-report=xml:reports/coverage.xml --junitxml=reports/$(MODULE)_junit.xml

help:
	@echo "make test-install          Install dependencies"
	@echo "make test-clean            Clean artifacts"
	@echo "make test MODULE=xxx       Run tests"
	@echo "make test-report MODULE=xxx  Generate report"
